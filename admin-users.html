<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management | iBlue Uganda Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #475569;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
      --info: #0ea5e9;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --light-gray: #e2e8f0;
      --border: #cbd5e1;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    body {
      background-color: #f1f5f9;
      color: var(--dark);
      min-height: 100vh;
      font-size: 14px;
    }

    /* Admin Layout */
    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .admin-sidebar {
      width: 260px;
      background: white;
      border-right: 1px solid var(--border);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      font-size: 1.3rem;
    }

    .admin-logo i {
      font-size: 1.8rem;
    }

    .sidebar-nav {
      padding: 20px 0;
    }

    .nav-group {
      margin-bottom: 24px;
    }

    .nav-group h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--gray);
      padding: 0 20px 10px;
      letter-spacing: 0.5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--dark);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: var(--light);
      color: var(--primary);
    }

    .nav-item.active {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    .nav-item span {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .badge {
      margin-left: auto;
      background: var(--danger);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 22px;
      height: 22px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      position: absolute;
      bottom: 0;
      width: 100%;
      background: white;
    }

    .admin-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
    }

    .admin-info h4 {
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .admin-info p {
      font-size: 0.8rem;
      color: var(--gray);
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      width: 44px;
      height: 44px;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      border-radius: var(--radius);
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
      display: none;
    }

    /* Main Content */
    .admin-main {
      flex: 1;
      margin-left: 260px;
      padding: 0;
      width: 100%;
      transition: margin-left 0.3s ease;
    }

    /* Top Header */
    .admin-header {
      background: white;
      padding: 18px 30px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 90;
    }

    .header-title h1 {
      font-size: 1.5rem;
      color: var(--dark);
      font-weight: 600;
    }

    .header-title p {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-btn {
      background: var(--light);
      color: var(--dark);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      position: relative;
      font-size: 1.1rem;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      min-width: 44px;
      min-height: 44px;
    }

    .header-btn:hover {
      background: var(--primary);
      color: white;
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      padding: 0 4px;
    }

    .admin-search {
      position: relative;
      flex: 1;
      max-width: 250px;
    }

    .admin-search input {
      padding: 12px 40px 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      font-size: 0.9rem;
      background: var(--light);
      min-height: 44px;
    }

    .admin-search i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }

    /* Content Area */
    .content-wrapper {
      padding: 30px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.active { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.verified { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.admins { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-change {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }

    .stat-change.positive {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .stat-change.negative {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
    }

    /* Filters Bar */
    .filters-bar {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 180px;
    }

    .filter-group label {
      font-size: 0.85rem;
      color: var(--gray);
      font-weight: 500;
    }

    .filter-select {
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 0.9rem;
      color: var(--dark);
      width: 100%;
      min-height: 44px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .date-range {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    .date-input {
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      flex: 1;
      min-height: 44px;
    }

    .btn-filter {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      min-height: 44px;
      min-width: 44px;
    }

    .btn-filter:hover {
      background: var(--primary-dark);
    }

    .btn-export {
      background: var(--light);
      color: var(--dark);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      min-height: 44px;
      min-width: 44px;
    }

    .btn-export:hover {
      background: var(--light-gray);
    }

    /* Users Table */
    .users-table-container {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h2 {
      font-size: 1.2rem;
      color: var(--dark);
    }

    .pagination-info {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table thead {
      background: var(--light);
    }

    .users-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .users-table td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .users-table tbody tr {
      transition: background 0.2s;
    }

    .users-table tbody tr:hover {
      background: rgba(37, 99, 235, 0.03);
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-weight: 600;
      color: var(--dark);
    }

    .user-email {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      text-transform: capitalize;
    }

    .status-badge.active {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .status-badge.inactive {
      background: rgba(107, 114, 128, 0.1);
      color: var(--gray);
    }

    .status-badge.banned {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }

    .role-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      text-transform: uppercase;
    }

    .role-badge.user {
      background: rgba(107, 114, 128, 0.1);
      color: var(--gray);
    }

    .role-badge.super_admin {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }

    .role-badge.content_manager {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .role-badge.support_staff {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .verification-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .verification-badge.verified {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .verification-badge.pending {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .verification-badge.not-verified {
      background: rgba(107, 114, 128, 0.1);
      color: var(--gray);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-action {
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .btn-view {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .btn-view:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .btn-edit {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .btn-edit:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .btn-ban {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }

    .btn-ban:hover {
      background: rgba(220, 38, 38, 0.2);
    }

    .btn-message {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    .btn-message:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    /* Table Footer */
    .table-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid var(--border);
      color: var(--dark);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 44px;
      min-height: 44px;
    }

    .page-btn:hover:not(:disabled) {
      background: var(--light);
      border-color: var(--primary);
      color: var(--primary);
    }

    .page-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      margin: 0 10px;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .rows-per-page select {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 0.9rem;
      min-height: 44px;
    }

    /* Loading States */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(37, 99, 235, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--light-gray);
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: var(--dark);
    }

    .empty-state p {
      color: var(--gray);
      margin-bottom: 25px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 1.2rem;
      color: var(--dark);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--gray);
      cursor: pointer;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      min-width: 44px;
      min-height: 44px;
    }

    .modal-close:hover {
      background: var(--light);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      transition: border 0.2s;
      min-height: 44px;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
      min-width: 44px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--light-gray);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .filter-group {
        min-width: 160px;
      }
    }

    @media (max-width: 1024px) {
      .admin-sidebar {
        transform: translateX(-100%);
      }
      
      .admin-sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .admin-main {
        margin-left: 0;
      }
      
      .mobile-menu-toggle {
        display: flex;
      }
      
      .sidebar-header span,
      .nav-item span,
      .nav-group h3,
      .admin-info,
      .badge {
        display: none;
      }
      
      .admin-logo {
        justify-content: center;
      }
      
      .nav-item {
        justify-content: center;
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .filters-bar {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .filter-select,
      .date-input {
        width: 100%;
      }
      
      .date-range {
        flex-direction: column;
        gap: 10px;
      }
      
      .users-table {
        display: block;
        overflow-x: auto;
        font-size: 0.85rem;
      }
      
      .users-table th,
      .users-table td {
        padding: 12px 10px;
      }
      
      .action-buttons {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .btn-action {
        width: 32px;
        height: 32px;
        font-size: 0.85rem;
      }
      
      .table-footer {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .pagination {
        order: -1;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .rows-per-page {
        width: 100%;
      }
      
      .rows-per-page select {
        width: 100%;
      }
      
      .modal {
        width: 95%;
        margin: 10px;
      }
    }

    @media (max-width: 768px) {
      .content-wrapper {
        padding: 15px;
      }
      
      .admin-header {
        padding: 15px;
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .header-title {
        text-align: center;
      }
      
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .admin-search {
        max-width: 100%;
        order: 2;
        width: 100%;
      }
      
      .admin-search input {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .stat-card {
        padding: 20px;
      }
      
      .stat-value {
        font-size: 1.8rem;
      }
      
      .filters-bar {
        padding: 12px;
      }
      
      .filter-group label {
        font-size: 0.8rem;
      }
      
      .filter-select,
      .date-input {
        padding: 10px 12px;
        font-size: 0.85rem;
      }
      
      .btn-filter,
      .btn-export {
        width: 100%;
        justify-content: center;
        padding: 12px;
      }
      
      .users-table {
        font-size: 0.8rem;
      }
      
      .users-table th,
      .users-table td {
        padding: 10px 8px;
      }
      
      .user-cell {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .user-avatar {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
      }
      
      .user-info {
        gap: 3px;
      }
      
      .user-name {
        font-size: 0.9rem;
      }
      
      .user-email {
        font-size: 0.75rem;
      }
      
      .status-badge,
      .role-badge,
      .verification-badge {
        padding: 4px 8px;
        font-size: 0.7rem;
      }
      
      .table-header {
        padding: 15px;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .table-header h2 {
        font-size: 1.1rem;
      }
      
      .pagination-info {
        font-size: 0.8rem;
      }
      
      .pagination {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .page-btn {
        width: 36px;
        height: 36px;
        font-size: 0.8rem;
      }
      
      .page-info {
        margin: 0 5px;
        font-size: 0.8rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 15px;
      }
      
      .modal-header h3 {
        font-size: 1.1rem;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      /* Hide less important columns on mobile */
      .users-table th:nth-child(5),
      .users-table td:nth-child(5),
      .users-table th:nth-child(6),
      .users-table td:nth-child(6),
      .users-table th:nth-child(7),
      .users-table td:nth-child(7) {
        display: none;
      }
    }

    @media (max-width: 576px) {
      body {
        font-size: 13px;
      }
      
      .content-wrapper {
        padding: 10px;
      }
      
      .admin-header {
        padding: 12px;
        gap: 12px;
      }
      
      .header-title h1 {
        font-size: 1.3rem;
      }
      
      .header-title p {
        font-size: 0.8rem;
      }
      
      .header-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      
      .mobile-menu-toggle {
        width: 40px;
        height: 40px;
      }
      
      .stats-grid {
        gap: 10px;
      }
      
      .stat-card {
        padding: 16px;
      }
      
      .stat-header {
        margin-bottom: 12px;
      }
      
      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      .stat-label {
        font-size: 0.8rem;
      }
      
      .filters-bar {
        padding: 10px;
        gap: 12px;
      }
      
      .filter-group {
        gap: 5px;
      }
      
      .filter-group label {
        font-size: 0.75rem;
      }
      
      .filter-select,
      .date-input {
        padding: 10px;
        font-size: 0.85rem;
      }
      
      .users-table-container {
        border-radius: 6px;
      }
      
      .users-table {
        font-size: 0.75rem;
      }
      
      .users-table th {
        font-size: 0.75rem;
        padding: 8px 6px;
      }
      
      .users-table td {
        padding: 8px 6px;
      }
      
      .action-buttons {
        gap: 4px;
      }
      
      .btn-action {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
      }
      
      .table-header,
      .table-footer {
        padding: 12px;
      }
      
      .modal {
        width: 98%;
        margin: 5px;
        max-height: 95vh;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 12px;
      }
      
      .form-control {
        padding: 10px;
        font-size: 0.9rem;
      }
      
      .btn {
        padding: 10px 14px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 425px) {
      .header-actions {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .mobile-menu-toggle {
        order: 1;
      }
      
      .admin-search {
        order: 3;
      }
      
      .stats-grid {
        gap: 8px;
      }
      
      .stat-card {
        padding: 14px;
      }
      
      .stat-value {
        font-size: 1.3rem;
      }
      
      .users-table th:nth-child(4),
      .users-table td:nth-child(4) {
        display: none;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn-action {
        width: 28px;
        height: 28px;
      }
      
      .pagination {
        gap: 3px;
      }
      
      .page-btn {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
      }
      
      .page-info {
        font-size: 0.75rem;
      }
    }

    @media (max-width: 375px) {
      .header-title h1 {
        font-size: 1.2rem;
      }
      
      .stat-card {
        padding: 12px;
      }
      
      .stat-value {
        font-size: 1.2rem;
      }
      
      .users-table th:nth-child(3),
      .users-table td:nth-child(3) {
        display: none;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.8rem;
      }
      
      .page-btn {
        width: 30px;
        height: 30px;
        font-size: 0.7rem;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #1e293b;
        --dark: #f8fafc;
        --border: #334155;
        --secondary: #cbd5e1;
        --gray: #94a3b8;
      }
      
      body {
        background-color: #0f172a;
        color: var(--dark);
      }
      
      .admin-sidebar,
      .admin-header,
      .stat-card,
      .filters-bar,
      .users-table-container,
      .modal {
        background: #1e293b;
        border-color: var(--border);
      }
      
      .admin-search input,
      .filter-select,
      .date-input,
      .form-control {
        background: #334155;
        border-color: var(--border);
        color: var(--dark);
      }
      
      .admin-search input::placeholder {
        color: #94a3b8;
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .btn-action,
      .page-btn,
      .header-btn,
      .btn,
      .nav-item {
        min-height: 44px;
      }
      
      .filter-select,
      select,
      input[type="date"],
      .form-control {
        min-height: 44px;
        font-size: 16px;
      }
      
      .nav-item {
        padding: 16px 20px;
      }
      
      /* Improve touch scrolling */
      .admin-sidebar {
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>
<body>
  <!-- Admin Layout -->
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <a href="admin-dashboard.html" class="admin-logo">
          <i class="fas fa-store"></i>
          <span>iBlue Admin</span>
        </a>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-group">
          <h3>Dashboard</h3>
          <a href="admin-dashboard.html" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Overview</span>
          </a>
        </div>
        
        <div class="nav-group">
          <h3>Content</h3>
          <a href="admin-ads.html" class="nav-item">
            <i class="fas fa-ad"></i>
            <span>Ads Management</span>
            <span class="badge" id="pendingAdsBadge">0</span>
          </a>
          <a href="admin-categories.html" class="nav-item">
            <i class="fas fa-tags"></i>
            <span>Categories</span>
          </a>
          <a href="admin-promotions.html" class="nav-item">
            <i class="fas fa-bullhorn"></i>
            <span>Promotions</span>
          </a>
        </div>
        
        <div class="nav-group">
          <h3>Users</h3>
          <a href="admin-users.html" class="nav-item active">
            <i class="fas fa-users"></i>
            <span>User Management</span>
          </a>
          <a href="admin-reports.html" class="nav-item">
            <i class="fas fa-flag"></i>
            <span>Reports</span>
            <span class="badge" id="pendingReportsBadge">0</span>
          </a>
          <a href="admin-messages.html" class="nav-item">
            <i class="fas fa-comments"></i>
            <span>Messages</span>
          </a>
        </div>
        
        <div class="nav-group">
          <h3>Settings</h3>
          <a href="admin-settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <a href="admin-activity.html" class="nav-item">
            <i class="fas fa-history"></i>
            <span>Activity Log</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="admin-profile">
          <div class="admin-avatar" id="adminAvatar">A</div>
          <div class="admin-info">
            <h4 id="adminName">Loading...</h4>
            <p id="adminRole">Super Admin</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="admin-main">
      <!-- Header -->
      <header class="admin-header">
        <div class="header-actions">
          <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
          </button>
          
          <div class="admin-search">
            <input type="text" id="searchUsers" placeholder="Search users...">
            <i class="fas fa-search"></i>
          </div>
        </div>
        
        <div class="header-title">
          <h1>User Management</h1>
          <p>Manage all user accounts and permissions</p>
        </div>
        
        <div class="header-actions">
          <button class="header-btn" onclick="refreshData()">
            <i class="fas fa-redo"></i>
          </button>
          
          <a href="notifications.html" class="header-btn">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="headerNotificationBadge">3</span>
          </a>
          
          <button class="header-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <!-- Content -->
      <div class="content-wrapper">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon users">
                <i class="fas fa-users"></i>
              </div>
              <span class="stat-change positive" id="totalUsersChange">+12%</span>
            </div>
            <div class="stat-value" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon active">
                <i class="fas fa-user-check"></i>
              </div>
              <span class="stat-change positive" id="activeUsersChange">+8%</span>
            </div>
            <div class="stat-value" id="activeUsers">0</div>
            <div class="stat-label">Active Users</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon verified">
                <i class="fas fa-badge-check"></i>
              </div>
              <span class="stat-change positive" id="verifiedUsersChange">+15%</span>
            </div>
            <div class="stat-value" id="verifiedUsers">0</div>
            <div class="stat-label">Verified Users</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon admins">
                <i class="fas fa-user-shield"></i>
              </div>
              <span class="stat-change negative" id="adminUsersChange">-2%</span>
            </div>
            <div class="stat-value" id="adminUsers">0</div>
            <div class="stat-label">Admin Users</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
          <div class="filter-group">
            <label>User Status</label>
            <select class="filter-select" id="filterStatus">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="banned">Banned</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>User Role</label>
            <select class="filter-select" id="filterRole">
              <option value="">All Roles</option>
              <option value="user">Regular User</option>
              <option value="super_admin">Super Admin</option>
              <option value="content_manager">Content Manager</option>
              <option value="support_staff">Support Staff</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Verification</label>
            <select class="filter-select" id="filterVerification">
              <option value="">All</option>
              <option value="verified">Verified</option>
              <option value="pending">Pending</option>
              <option value="not_verified">Not Verified</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Date Range</label>
            <div class="date-range">
              <input type="date" class="date-input" id="dateFrom">
              <input type="date" class="date-input" id="dateTo">
            </div>
          </div>
          
          <button class="btn-filter" onclick="applyFilters()">
            <i class="fas fa-filter"></i> Apply Filters
          </button>
          
          <button class="btn-export" onclick="exportUsers()">
            <i class="fas fa-download"></i> Export CSV
          </button>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
          <div class="table-header">
            <h2>Users List</h2>
            <div class="pagination-info">
              Showing <span id="startRow">0</span>-<span id="endRow">0</span> of <span id="totalRows">0</span> users
            </div>
          </div>
          
          <div class="loading" id="loading">
            <div class="spinner"></div>
          </div>
          
          <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-users-slash"></i>
            <h3>No Users Found</h3>
            <p>Try adjusting your filters or search query</p>
            <button class="btn-primary" onclick="clearFilters()">
              Clear Filters
            </button>
          </div>
          
          <table class="users-table" id="usersTable" style="display: none;">
            <thead>
              <tr>
                <th>User</th>
                <th>Status</th>
                <th>Role</th>
                <th>Verification</th>
                <th>Ads</th>
                <th>Joined</th>
                <th>Last Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
          
          <div class="table-footer">
            <div class="rows-per-page">
              <select id="rowsPerPage" onchange="changeRowsPerPage()">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
              </select>
            </div>
            
            <div class="pagination">
              <button class="page-btn" id="firstPage" onclick="goToPage(1)" disabled>
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button class="page-btn" id="prevPage" onclick="goToPage(currentPage - 1)" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              
              <span class="page-info">
                Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
              </span>
              
              <button class="page-btn" id="nextPage" onclick="goToPage(currentPage + 1)" disabled>
                <i class="fas fa-chevron-right"></i>
              </button>
              <button class="page-btn" id="lastPage" onclick="goToPage(totalPages)" disabled>
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- User Detail Modal -->
  <div class="modal-overlay" id="userDetailModal">
    <div class="modal">
      <div class="modal-header">
        <h3>User Details</h3>
        <button class="modal-close" onclick="closeModal('userDetailModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="userDetailContent">
        <!-- User details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('userDetailModal')">
          Close
        </button>
        <button class="btn btn-primary" id="userDetailActionBtn">
          <i class="fas fa-envelope"></i> Send Message
        </button>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="editUserModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit User</h3>
        <button class="modal-close" onclick="closeModal('editUserModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" class="form-control" id="editFullName" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" class="form-control" id="editPhone">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Location</label>
              <input type="text" class="form-control" id="editLocation">
            </div>
            
            <div class="form-group">
              <label>District</label>
              <input type="text" class="form-control" id="editDistrict">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>User Role</label>
              <select class="form-control" id="editRole">
                <option value="user">Regular User</option>
                <option value="super_admin">Super Admin</option>
                <option value="content_manager">Content Manager</option>
                <option value="support_staff">Support Staff</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Account Status</label>
              <select class="form-control" id="editStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="banned">Banned</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Verification Status</label>
            <select class="form-control" id="editVerification">
              <option value="not_verified">Not Verified</option>
              <option value="pending">Pending Verification</option>
              <option value="verified">Verified</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Admin Notes</label>
            <textarea class="form-control" id="editNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editUserModal')">
          Cancel
        </button>
        <button class="btn btn-danger" id="deleteUserBtn">
          <i class="fas fa-trash"></i> Delete User
        </button>
        <button class="btn btn-primary" onclick="saveUserChanges()">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Ban User Modal -->
  <div class="modal-overlay" id="banUserModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Ban User Account</h3>
        <button class="modal-close" onclick="closeModal('banUserModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>User</label>
          <input type="text" class="form-control" id="banUserName" readonly>
        </div>
        
        <div class="form-group">
          <label>Reason for Ban</label>
          <select class="form-control" id="banReason">
            <option value="spam">Spam Posting</option>
            <option value="scam">Scam/Fraud</option>
            <option value="offensive">Offensive Content</option>
            <option value="tos_violation">Terms of Service Violation</option>
            <option value="multiple_reports">Multiple User Reports</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ban Duration</label>
          <select class="form-control" id="banDuration">
            <option value="1">1 Day</option>
            <option value="7">7 Days</option>
            <option value="30">30 Days</option>
            <option value="90">90 Days</option>
            <option value="permanent">Permanent</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Details (Optional)</label>
          <textarea class="form-control" id="banDetails" rows="3" placeholder="Provide additional details..."></textarea>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="banDeactivateAds"> Deactivate all user's ads
          </label>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="banNotifyUser"> Notify user about the ban
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('banUserModal')">
          Cancel
        </button>
        <button class="btn btn-danger" onclick="confirmBanUser()">
          <i class="fas fa-ban"></i> Ban User
        </button>
      </div>
    </div>
  </div>

  <!-- Verification Modal -->
  <div class="modal-overlay" id="verificationModal">
    <div class="modal">
      <div class="modal-header">
        <h3>User Verification</h3>
        <button class="modal-close" onclick="closeModal('verificationModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="verificationContent">
          <!-- Verification details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('verificationModal')">
          Cancel
        </button>
        <button class="btn btn-danger" onclick="rejectVerification()">
          <i class="fas fa-times"></i> Reject
        </button>
        <button class="btn btn-primary" onclick="approveVerification()">
          <i class="fas fa-check"></i> Approve
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const supabaseUrl = "https://uufhvmmgwzkxvvdbqemz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1Zmh2bW1nd3preHZ2ZGJxZW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDIzNTYsImV4cCI6MjA4NTg3ODM1Nn0.WABHx4ilFRkhPHP-y4ZC4E8Kb7PRqY-cyxI8cVS8Tyc";
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Global Variables
    let currentUser = null;
    let allUsers = [];
    let filteredUsers = [];
    let currentUserId = null;
    let currentPage = 1;
    let rowsPerPage = 25;
    let totalPages = 1;
    let totalRows = 0;
    let currentFilters = {
      search: '',
      status: '',
      role: '',
      verification: '',
      dateFrom: '',
      dateTo: ''
    };

    // Initialize Admin Dashboard
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Admin Users Page Loading...');
      console.log('Supabase client created:', !!sb);
      console.log('Current URL:', window.location.href);
      
      try {
        // First, check authentication status
        const isAuthenticated = await checkAuthStatus();
        if (!isAuthenticated) {
          console.log('User not authenticated, redirecting to login');
          return;
        }
        
        // Setup mobile menu functionality
        setupMobileMenu();
        
        // Check admin authentication (more thorough check)
        await checkAdminAuth();
        
        // Load admin profile
        await loadAdminProfile();
        
        // Load initial data
        await loadDashboardStats();
        await loadUsers();
        await loadPendingCounts();
        
        // Setup event listeners
        setupEventListeners();
        
        // Set up auto-refresh every 60 seconds
        setInterval(async () => {
          await loadDashboardStats();
          await loadPendingCounts();
        }, 60000);
        
        console.log('Admin dashboard initialized successfully');
      } catch (error) {
        console.error('Failed to initialize admin dashboard:', error);
        showToast('Failed to load dashboard. Please try again.', 'error');
      }
    });

    // Check Authentication Status
    async function checkAuthStatus() {
      try {
        const { data: { session }, error } = await sb.auth.getSession();
        
        if (error) {
          console.error('Error checking session:', error);
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return false;
        }
        
        if (!session) {
          console.log('No active session found');
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return false;
        }
        
        console.log('Session found, user:', session.user.email);
        return true;
      } catch (error) {
        console.error('Error in checkAuthStatus:', error);
        window.location.href = 'login.html';
        return false;
      }
    }

    // Setup Mobile Menu
    function setupMobileMenu() {
      const mobileToggle = document.getElementById('mobileMenuToggle');
      const sidebar = document.querySelector('.admin-sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (mobileToggle && sidebar && overlay) {
        mobileToggle.addEventListener('click', toggleMobileSidebar);
        overlay.addEventListener('click', toggleMobileSidebar);
        
        // Close sidebar when clicking a nav item on mobile
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 1024) {
            if (e.target.closest('.nav-item')) {
              toggleMobileSidebar();
            }
          }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
          if (window.innerWidth > 1024) {
            sidebar.classList.remove('mobile-open');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
          }
        });
      }
    }
    
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.admin-sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (sidebar && overlay) {
        sidebar.classList.toggle('mobile-open');
        
        if (sidebar.classList.contains('mobile-open')) {
          overlay.style.display = 'block';
          document.body.style.overflow = 'hidden';
        } else {
          overlay.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      }
    }

    // Check Admin Authentication
    async function checkAdminAuth() {
      try {
        // First, check if we have an existing session
        const { data: { session }, error: sessionError } = await sb.auth.getSession();
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        if (!session) {
          console.log('No active session found, redirecting to login');
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        // Get the current user from the session
        const { data: { user }, error: userError } = await sb.auth.getUser();
        
        if (userError) {
          console.error('User error:', userError);
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        if (!user) {
          console.log('No user found, redirecting to login');
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        console.log('User found:', user.email);
        
        // Check if user is admin
        const { data: profile, error: profileError } = await sb
          .from('profiles')
          .select('is_admin, admin_role')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          console.error('Profile error:', profileError);
          // If profile doesn't exist, redirect to login
          window.location.href = 'login.html';
          return;
        }
        
        if (!profile || !profile.is_admin) {
          showToast('Access denied. Admin privileges required.', 'error');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          return;
        }
        
        currentUser = user;
        console.log('Admin user authenticated:', user.email);
        
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = 'login.html';
      }
    }

    // Load Admin Profile
    async function loadAdminProfile() {
      try {
        // Check if currentUser exists
        if (!currentUser || !currentUser.id) {
          console.error('No authenticated user found when loading profile');
          // Try to get user from session
          const { data: { user } } = await sb.auth.getUser();
          if (user) {
            currentUser = user;
            console.log('Retrieved user from session:', user.email);
          } else {
            console.error('Cannot load profile: No user ID available');
            // Set default values
            document.getElementById('adminName').textContent = 'Admin';
            document.getElementById('adminRole').textContent = 'Administrator';
            return;
          }
        }
        
        const { data: profile, error } = await sb
          .from('profiles')
          .select('full_name, avatar_url, admin_role')
          .eq('id', currentUser.id)
          .single();
        
        if (error) {
          console.error('Error loading admin profile from DB:', error);
          // Set default values
          document.getElementById('adminName').textContent = currentUser.email || 'Admin';
          document.getElementById('adminRole').textContent = 'Administrator';
          return;
        }
        
        if (profile) {
          // Update sidebar profile
          document.getElementById('adminName').textContent = profile.full_name || 'Admin';
          document.getElementById('adminRole').textContent = profile.admin_role || 'Admin';
          
          if (profile.avatar_url) {
            document.getElementById('adminAvatar').innerHTML = `<img src="${profile.avatar_url}" alt="${profile.full_name}">`;
          } else if (profile.full_name) {
            document.getElementById('adminAvatar').textContent = profile.full_name.charAt(0).toUpperCase();
          }
        } else {
          // No profile found in database, set defaults
          document.getElementById('adminName').textContent = currentUser.email || 'Admin';
          document.getElementById('adminRole').textContent = 'Administrator';
        }
        
        console.log('Admin profile loaded successfully');
      } catch (error) {
        console.error('Error loading admin profile:', error);
        // Set default values on error
        document.getElementById('adminName').textContent = 'Admin';
        document.getElementById('adminRole').textContent = 'Administrator';
      }
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Search input
      const searchInput = document.getElementById('searchUsers');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(function(e) {
          currentFilters.search = e.target.value;
          currentPage = 1;
          filterUsers();
        }, 300));
      }
      
      // Filter selects
      const filterStatus = document.getElementById('filterStatus');
      const filterRole = document.getElementById('filterRole');
      const filterVerification = document.getElementById('filterVerification');
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      
      if (filterStatus) {
        filterStatus.addEventListener('change', function(e) {
          currentFilters.status = e.target.value;
          currentPage = 1;
          filterUsers();
        });
      }
      
      if (filterRole) {
        filterRole.addEventListener('change', function(e) {
          currentFilters.role = e.target.value;
          currentPage = 1;
          filterUsers();
        });
      }
      
      if (filterVerification) {
        filterVerification.addEventListener('change', function(e) {
          currentFilters.verification = e.target.value;
          currentPage = 1;
          filterUsers();
        });
      }
      
      if (dateFrom) {
        dateFrom.addEventListener('change', function(e) {
          currentFilters.dateFrom = e.target.value;
          currentPage = 1;
          filterUsers();
        });
      }
      
      if (dateTo) {
        dateTo.addEventListener('change', function(e) {
          currentFilters.dateTo = e.target.value;
          currentPage = 1;
          filterUsers();
        });
      }
      
      // Close modals on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
      
      // Close modals when clicking outside on mobile
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) {
            closeAllModals();
          }
        });
      });
    }

    // Load Dashboard Statistics
    async function loadDashboardStats() {
      try {
        console.log('Loading dashboard statistics...');
        
        // Get total users count
        const { count: totalCount, error: totalError } = await sb
          .from('profiles')
          .select('*', { count: 'exact', head: true });
        
        if (totalError) throw totalError;
        
        // Get active users (users with recent activity or ads)
        const { data: activeData, error: activeError } = await sb
          .from('profiles')
          .select('id')
          .gte('last_active', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());
        
        if (activeError) throw activeError;
        
        // Get verified users
        const { data: verifiedData, error: verifiedError } = await sb
          .from('profiles')
          .select('id')
          .eq('is_verified', true);
        
        if (verifiedError) throw verifiedError;
        
        // Get admin users
        const { data: adminData, error: adminError } = await sb
          .from('profiles')
          .select('id')
          .eq('is_admin', true);
        
        if (adminError) throw adminError;
        
        // Update UI
        document.getElementById('totalUsers').textContent = totalCount || 0;
        document.getElementById('activeUsers').textContent = activeData?.length || 0;
        document.getElementById('verifiedUsers').textContent = verifiedData?.length || 0;
        document.getElementById('adminUsers').textContent = adminData?.length || 0;
        
        console.log('Statistics loaded successfully');
        
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // Load Pending Counts for Badges
    async function loadPendingCounts() {
      try {
        // Get pending ads count
        const { count: pendingAdsCount, error: adsError } = await sb
          .from('ads')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'pending');
        
        if (!adsError) {
          document.getElementById('pendingAdsBadge').textContent = pendingAdsCount || 0;
          document.getElementById('pendingAdsBadge').style.display = pendingAdsCount > 0 ? 'flex' : 'none';
        }
        
        // Get pending reports count
        const { count: pendingReportsCount, error: reportsError } = await sb
          .from('reports')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'pending');
        
        if (!reportsError) {
          document.getElementById('pendingReportsBadge').textContent = pendingReportsCount || 0;
          document.getElementById('pendingReportsBadge').style.display = pendingReportsCount > 0 ? 'flex' : 'none';
        }
        
        // Get unread notifications for admin
        if (currentUser && currentUser.id) {
          const { data: notifications, error: notifError } = await sb
            .from('notifications')
            .select('id')
            .eq('user_id', currentUser.id)
            .eq('is_read', false);
          
          if (!notifError && notifications) {
            document.getElementById('headerNotificationBadge').textContent = notifications.length > 9 ? '9+' : notifications.length;
            document.getElementById('headerNotificationBadge').style.display = notifications.length > 0 ? 'flex' : 'none';
          }
        }
        
      } catch (error) {
        console.error('Error loading pending counts:', error);
      }
    }

    // Load Users
    async function loadUsers() {
      const loading = document.getElementById('loading');
      const table = document.getElementById('usersTable');
      const emptyState = document.getElementById('emptyState');
      
      if (loading) loading.style.display = 'flex';
      if (table) table.style.display = 'none';
      if (emptyState) emptyState.style.display = 'none';
      
      try {
        console.log('Loading users...');
        
        // Build query
        let query = sb
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });
        
        // Apply initial filters
        if (currentFilters.status) {
          // Note: profiles table doesn't have status column, we'll need to infer from other factors
          // For now, we'll skip this filter
        }
        
        if (currentFilters.role) {
          if (currentFilters.role === 'user') {
            query = query.eq('is_admin', false);
          } else {
            query = query.eq('admin_role', currentFilters.role);
          }
        }
        
        if (currentFilters.verification) {
          if (currentFilters.verification === 'verified') {
            query = query.eq('is_verified', true);
          } else if (currentFilters.verification === 'not_verified') {
            query = query.eq('is_verified', false).is('verification_doc_url', null);
          } else if (currentFilters.verification === 'pending') {
            query = query.eq('is_verified', false).not('verification_doc_url', 'is', null);
          }
        }
        
        if (currentFilters.dateFrom) {
          query = query.gte('created_at', currentFilters.dateFrom + 'T00:00:00Z');
        }
        
        if (currentFilters.dateTo) {
          query = query.lte('created_at', currentFilters.dateTo + 'T23:59:59Z');
        }
        
        // Get total count
        const { count, error: countError } = await query.select('*', { count: 'exact', head: true });
        
        if (countError) throw countError;
        
        // Apply pagination
        const from = (currentPage - 1) * rowsPerPage;
        const to = from + rowsPerPage - 1;
        
        const { data: users, error } = await query.range(from, to);
        
        if (error) throw error;
        
        allUsers = users || [];
        totalRows = count || 0;
        totalPages = Math.ceil(totalRows / rowsPerPage);
        
        console.log(`Loaded ${allUsers.length} users, total: ${totalRows}`);
        
        // Update pagination
        updatePagination();
        
        // Render users
        renderUsers();
        
      } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users. Please try again.', 'error');
        
        if (emptyState) {
          emptyState.style.display = 'block';
          emptyState.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Users</h3>
            <p>Please check your connection and try again</p>
            <button class="btn-primary" onclick="loadUsers()">
              <i class="fas fa-redo"></i> Retry
            </button>
          `;
        }
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }

    // Filter Users
    function filterUsers() {
      filteredUsers = allUsers.filter(user => {
        // Search filter
        if (currentFilters.search) {
          const searchLower = currentFilters.search.toLowerCase();
          const nameMatch = user.full_name?.toLowerCase().includes(searchLower);
          const emailMatch = user.email?.toLowerCase().includes(searchLower);
          const phoneMatch = user.phone?.toLowerCase().includes(searchLower);
          
          if (!nameMatch && !emailMatch && !phoneMatch) {
            return false;
          }
        }
        
        // Status filter (inferred)
        if (currentFilters.status) {
          // Infer status from last_active and other factors
          const lastActive = new Date(user.last_active || user.created_at);
          const daysSinceActive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
          
          if (currentFilters.status === 'active' && daysSinceActive > 30) {
            return false;
          } else if (currentFilters.status === 'inactive' && daysSinceActive <= 30) {
            return false;
          } else if (currentFilters.status === 'banned') {
            // Check if user is banned (you'd need a banned column or flag)
            return false; // Placeholder
          }
        }
        
        // Role filter
        if (currentFilters.role) {
          if (currentFilters.role === 'user' && user.is_admin) {
            return false;
          } else if (currentFilters.role !== 'user' && user.admin_role !== currentFilters.role) {
            return false;
          }
        }
        
        // Verification filter
        if (currentFilters.verification) {
          if (currentFilters.verification === 'verified' && !user.is_verified) {
            return false;
          } else if (currentFilters.verification === 'not_verified' && (user.is_verified || user.verification_doc_url)) {
            return false;
          } else if (currentFilters.verification === 'pending' && (!user.verification_doc_url || user.is_verified)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Update total rows for filtered results
      totalRows = filteredUsers.length;
      totalPages = Math.ceil(totalRows / rowsPerPage);
      
      // Reset to first page if needed
      if (currentPage > totalPages) {
        currentPage = 1;
      }
      
      updatePagination();
      renderUsers();
    }

    // Render Users
    function renderUsers() {
      const tableBody = document.getElementById('usersTableBody');
      const table = document.getElementById('usersTable');
      const emptyState = document.getElementById('emptyState');
      const loading = document.getElementById('loading');
      
      if (loading) loading.style.display = 'none';
      
      if (!tableBody || !table || !emptyState) {
        console.error('Table elements not found');
        return;
      }
      
      if (filteredUsers.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      table.style.display = 'table';
      emptyState.style.display = 'none';
      
      // Get users for current page
      const startIdx = (currentPage - 1) * rowsPerPage;
      const endIdx = Math.min(startIdx + rowsPerPage, filteredUsers.length);
      const pageUsers = filteredUsers.slice(startIdx, endIdx);
      
      // Update pagination info
      document.getElementById('startRow').textContent = startIdx + 1;
      document.getElementById('endRow').textContent = endIdx;
      document.getElementById('totalRows').textContent = totalRows;
      
      // Clear table
      tableBody.innerHTML = '';
      
      // Render each user
      pageUsers.forEach(user => {
        const row = createUserRow(user);
        tableBody.appendChild(row);
      });
    }

    // Create User Table Row
    function createUserRow(user) {
      const row = document.createElement('tr');
      
      // Get user initials for avatar
      const initials = user.full_name 
        ? user.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
        : user.email.substring(0, 2).toUpperCase();
      
      // Determine status badge
      const lastActive = new Date(user.last_active || user.created_at);
      const daysSinceActive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
      const status = daysSinceActive > 30 ? 'inactive' : 'active';
      
      // Determine verification badge
      let verificationStatus = 'not_verified';
      if (user.is_verified) {
        verificationStatus = 'verified';
      } else if (user.verification_doc_url) {
        verificationStatus = 'pending';
      }
      
      // Determine role badge
      let role = 'user';
      if (user.is_admin) {
        role = user.admin_role || 'super_admin';
      }
      
      row.innerHTML = `
        <td>
          <div class="user-cell">
            <div class="user-avatar">
              ${user.avatar_url 
                ? `<img src="${user.avatar_url}" alt="${user.full_name}">` 
                : initials}
            </div>
            <div class="user-info">
              <div class="user-name">${user.full_name || 'No Name'}</div>
              <div class="user-email">${user.email}</div>
              ${user.phone ? `<div class="user-phone">${user.phone}</div>` : ''}
            </div>
          </div>
        </td>
        <td>
          <span class="status-badge ${status}">${status}</span>
        </td>
        <td>
          <span class="role-badge ${role.replace('_', '')}">${role.replace('_', ' ')}</span>
        </td>
        <td>
          <span class="verification-badge ${verificationStatus}">
            <i class="fas fa-${verificationStatus === 'verified' ? 'check-circle' : verificationStatus === 'pending' ? 'clock' : 'times-circle'}"></i>
            ${verificationStatus.replace('_', ' ')}
          </span>
        </td>
        <td>
          <strong>${user.total_ads || 0}</strong> ads
        </td>
        <td>
          ${formatDate(user.created_at)}
        </td>
        <td>
          ${formatTimeAgo(user.last_active || user.created_at)}
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn-action btn-view" onclick="viewUser('${user.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-action btn-edit" onclick="editUser('${user.id}')" title="Edit User">
              <i class="fas fa-edit"></i>
            </button>
            ${user.is_admin ? '' : `
              <button class="btn-action btn-ban" onclick="banUser('${user.id}')" title="Ban User">
                <i class="fas fa-ban"></i>
              </button>
            `}
            <button class="btn-action btn-message" onclick="messageUser('${user.id}')" title="Send Message">
              <i class="fas fa-envelope"></i>
            </button>
          </div>
        </td>
      `;
      
      return row;
    }

    // Update Pagination
    function updatePagination() {
      const currentPageEl = document.getElementById('currentPage');
      const totalPagesEl = document.getElementById('totalPages');
      const firstPageBtn = document.getElementById('firstPage');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const lastPageBtn = document.getElementById('lastPage');
      
      if (currentPageEl) currentPageEl.textContent = currentPage;
      if (totalPagesEl) totalPagesEl.textContent = totalPages;
      
      // Update button states
      if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
      if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
      if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
      if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;
      
      // Generate page numbers
      const pagination = document.querySelector('.pagination');
      const pageInfo = document.querySelector('.page-info');
      
      if (!pagination || !pageInfo) return;
      
      // Remove existing page number buttons
      const existingPageBtns = pagination.querySelectorAll('.page-num');
      existingPageBtns.forEach(btn => btn.remove());
      
      // Add page number buttons
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      // Add page numbers before pageInfo
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn page-num ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => goToPage(i);
        pageInfo.parentNode.insertBefore(pageBtn, pageInfo);
      }
    }

    // Go to Specific Page
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      renderUsers();
      updatePagination();
      
      // Scroll to top of table
      const tableContainer = document.querySelector('.users-table-container');
      if (tableContainer) {
        tableContainer.scrollIntoView({
          behavior: 'smooth'
        });
      }
    }

    // Change Rows Per Page
    function changeRowsPerPage() {
      const rowsPerPageSelect = document.getElementById('rowsPerPage');
      if (rowsPerPageSelect) {
        rowsPerPage = parseInt(rowsPerPageSelect.value);
        currentPage = 1;
        filterUsers();
      }
    }

    // Apply Filters
    function applyFilters() {
      const filterStatus = document.getElementById('filterStatus');
      const filterRole = document.getElementById('filterRole');
      const filterVerification = document.getElementById('filterVerification');
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      
      if (filterStatus) currentFilters.status = filterStatus.value;
      if (filterRole) currentFilters.role = filterRole.value;
      if (filterVerification) currentFilters.verification = filterVerification.value;
      if (dateFrom) currentFilters.dateFrom = dateFrom.value;
      if (dateTo) currentFilters.dateTo = dateTo.value;
      
      currentPage = 1;
      filterUsers();
      showToast('Filters applied successfully');
    }

    // Clear Filters
    function clearFilters() {
      const filterStatus = document.getElementById('filterStatus');
      const filterRole = document.getElementById('filterRole');
      const filterVerification = document.getElementById('filterVerification');
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      const searchUsers = document.getElementById('searchUsers');
      
      if (filterStatus) filterStatus.value = '';
      if (filterRole) filterRole.value = '';
      if (filterVerification) filterVerification.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
      if (searchUsers) searchUsers.value = '';
      
      currentFilters = {
        search: '',
        status: '',
        role: '',
        verification: '',
        dateFrom: '',
        dateTo: ''
      };
      
      currentPage = 1;
      filterUsers();
      showToast('Filters cleared');
    }

    // View User Details
    async function viewUser(userId) {
      try {
        currentUserId = userId;
        
        // Get user details
        const { data: user, error } = await sb
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();
        
        if (error) throw error;
        
        // Get user's ads
        const { data: userAds, error: adsError } = await sb
          .from('ads')
          .select('id, title, price, status, created_at')
          .eq('seller_id', userId)
          .order('created_at', { ascending: false })
          .limit(10);
        
        // Get user's reports
        const { data: userReports, error: reportsError } = await sb
          .from('reports')
          .select('id, reason, status, created_at')
          .or(`reporter_id.eq.${userId},reported_user_id.eq.${userId}`)
          .order('created_at', { ascending: false })
          .limit(10);
        
        // Format user data
        const userDetails = `
          <div class="user-detail-view">
            <div class="form-row">
              <div class="form-group">
                <label>Full Name</label>
                <div class="detail-value">${user.full_name || 'Not set'}</div>
              </div>
              
              <div class="form-group">
                <label>Account Status</label>
                <div class="detail-value">
                  <span class="status-badge ${user.is_admin ? 'admin' : 'active'}">
                    ${user.is_admin ? 'Admin' : 'Active'}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Email</label>
                <div class="detail-value">${user.email}</div>
              </div>
              
              <div class="form-group">
                <label>Phone</label>
                <div class="detail-value">${user.phone || 'Not provided'}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Location</label>
                <div class="detail-value">${user.location || 'Not specified'}</div>
              </div>
              
              <div class="form-group">
                <label>District</label>
                <div class="detail-value">${user.district || 'Not specified'}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Total Ads</label>
                <div class="detail-value"><strong>${user.total_ads || 0}</strong> ads posted</div>
              </div>
              
              <div class="form-group">
                <label>Joined Date</label>
                <div class="detail-value">${formatDate(user.created_at)}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Last Active</label>
                <div class="detail-value">${formatTimeAgo(user.last_active || user.created_at)}</div>
              </div>
              
              <div class="form-group">
                <label>Verification</label>
                <div class="detail-value">
                  <span class="verification-badge ${user.is_verified ? 'verified' : user.verification_doc_url ? 'pending' : 'not_verified'}">
                    <i class="fas fa-${user.is_verified ? 'check-circle' : user.verification_doc_url ? 'clock' : 'times-circle'}"></i>
                    ${user.is_verified ? 'Verified' : user.verification_doc_url ? 'Pending Verification' : 'Not Verified'}
                  </span>
                </div>
              </div>
            </div>
            
            ${user.verification_doc_url ? `
              <div class="form-group">
                <label>Verification Document</label>
                <div class="detail-value">
                  <a href="${user.verification_doc_url}" target="_blank" class="btn btn-secondary" style="margin-top: 5px;">
                    <i class="fas fa-external-link-alt"></i> View Document
                  </a>
                </div>
              </div>
            ` : ''}
            
            ${userAds && userAds.length > 0 ? `
              <div class="form-group">
                <label>Recent Ads (${userAds.length})</label>
                <div class="detail-value" style="max-height: 200px; overflow-y: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Title</th>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Price</th>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${userAds.map(ad => `
                        <tr>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                            <a href="ad-detail.html?id=${ad.id}" target="_blank" style="color: #2563eb; text-decoration: none;">
                              ${ad.title.substring(0, 30)}${ad.title.length > 30 ? '...' : ''}
                            </a>
                          </td>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                            ${ad.price ? `UGX ${parseInt(ad.price).toLocaleString()}` : 'Price on request'}
                          </td>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                            <span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; 
                                  background: ${ad.status === 'active' ? 'rgba(22, 163, 74, 0.1)' : 
                                             ad.status === 'sold' ? 'rgba(59, 130, 246, 0.1)' : 
                                             'rgba(107, 114, 128, 0.1)'}; 
                                  color: ${ad.status === 'active' ? '#16a34a' : 
                                          ad.status === 'sold' ? '#2563eb' : '#64748b'};">
                              ${ad.status}
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}
            
            ${userReports && userReports.length > 0 ? `
              <div class="form-group">
                <label>Reports Involvement (${userReports.length})</label>
                <div class="detail-value" style="max-height: 200px; overflow-y: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Type</th>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Reason</th>
                        <th style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left;">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${userReports.map(report => `
                        <tr>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                            ${report.reporter_id === userId ? 'Reporter' : 'Reported'}
                          </td>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${report.reason}</td>
                          <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                            <span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; 
                                  background: ${report.status === 'pending' ? 'rgba(245, 158, 11, 0.1)' : 
                                             report.status === 'resolved' ? 'rgba(22, 163, 74, 0.1)' : 
                                             'rgba(107, 114, 128, 0.1)'}; 
                                  color: ${report.status === 'pending' ? '#f59e0b' : 
                                          report.status === 'resolved' ? '#16a34a' : '#64748b'};">
                              ${report.status}
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}
          </div>
        `;
        
        const userDetailContent = document.getElementById('userDetailContent');
        if (userDetailContent) {
          userDetailContent.innerHTML = userDetails;
        }
        
        // Update action button
        const actionBtn = document.getElementById('userDetailActionBtn');
        if (actionBtn) {
          actionBtn.innerHTML = '<i class="fas fa-envelope"></i> Send Message';
          actionBtn.onclick = () => messageUser(userId);
        }
        
        // Show modal
        openModal('userDetailModal');
        
      } catch (error) {
        console.error('Error loading user details:', error);
        showToast('Failed to load user details', 'error');
      }
    }

    // Edit User
    async function editUser(userId) {
      try {
        currentUserId = userId;
        
        // Get user details
        const { data: user, error } = await sb
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();
        
        if (error) throw error;
        
        // Fill form
        document.getElementById('editFullName').value = user.full_name || '';
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editLocation').value = user.location || '';
        document.getElementById('editDistrict').value = user.district || '';
        document.getElementById('editNotes').value = '';
        
        // Set role
        if (user.is_admin) {
          document.getElementById('editRole').value = user.admin_role || 'super_admin';
        } else {
          document.getElementById('editRole').value = 'user';
        }
        
        // Set status (inferred)
        const lastActive = new Date(user.last_active || user.created_at);
        const daysSinceActive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
        document.getElementById('editStatus').value = daysSinceActive > 30 ? 'inactive' : 'active';
        
        // Set verification
        if (user.is_verified) {
          document.getElementById('editVerification').value = 'verified';
        } else if (user.verification_doc_url) {
          document.getElementById('editVerification').value = 'pending';
        } else {
          document.getElementById('editVerification').value = 'not_verified';
        }
        
        // Update delete button
        const deleteBtn = document.getElementById('deleteUserBtn');
        if (deleteBtn) {
          deleteBtn.onclick = () => deleteUser(userId);
          deleteBtn.disabled = user.is_admin; // Can't delete admin users
        }
        
        // Show modal
        openModal('editUserModal');
        
      } catch (error) {
        console.error('Error loading user for edit:', error);
        showToast('Failed to load user details', 'error');
      }
    }

    // Save User Changes
    async function saveUserChanges() {
      try {
        const editFullName = document.getElementById('editFullName');
        const editPhone = document.getElementById('editPhone');
        const editLocation = document.getElementById('editLocation');
        const editDistrict = document.getElementById('editDistrict');
        const editRole = document.getElementById('editRole');
        const editStatus = document.getElementById('editStatus');
        const editVerification = document.getElementById('editVerification');
        
        if (!editFullName || !editRole || !editStatus || !editVerification) {
          throw new Error('Form elements not found');
        }
        
        const updates = {
          full_name: editFullName.value.trim(),
          phone: editPhone ? editPhone.value.trim() || null : null,
          location: editLocation ? editLocation.value.trim() || null : null,
          district: editDistrict ? editDistrict.value.trim() || null : null,
          updated_at: new Date().toISOString()
        };
        
        // Handle role changes
        const newRole = editRole.value;
        const isAdmin = newRole !== 'user';
        
        updates.is_admin = isAdmin;
        if (isAdmin) {
          updates.admin_role = newRole;
        } else {
          updates.admin_role = null;
        }
        
        // Handle verification
        const verification = editVerification.value;
        if (verification === 'verified') {
          updates.is_verified = true;
        } else if (verification === 'pending') {
          updates.is_verified = false;
          // Keep verification_doc_url as is
        } else {
          updates.is_verified = false;
        }
        
        // Update user
        const { error } = await sb
          .from('profiles')
          .update(updates)
          .eq('id', currentUserId);
        
        if (error) throw error;
        
        // Log admin action
        await sb.from('admin_actions').insert({
          admin_id: currentUser.id,
          action_type: 'user_verified',
          target_user_id: currentUserId,
          details: {
            action: 'user_updated',
            changes: updates
          }
        });
        
        // Close modal and refresh
        closeModal('editUserModal');
        await loadUsers();
        await loadDashboardStats();
        showToast('User updated successfully');
        
      } catch (error) {
        console.error('Error updating user:', error);
        showToast('Failed to update user', 'error');
      }
    }

    // Ban User
    async function banUser(userId) {
      try {
        currentUserId = userId;
        
        // Get user details
        const { data: user, error } = await sb
          .from('profiles')
          .select('full_name, email')
          .eq('id', userId)
          .single();
        
        if (error) throw error;
        
        // Fill ban form
        const banUserName = document.getElementById('banUserName');
        if (banUserName) {
          banUserName.value = `${user.full_name || 'User'} (${user.email})`;
        }
        
        // Show modal
        openModal('banUserModal');
        
      } catch (error) {
        console.error('Error loading user for ban:', error);
        showToast('Failed to load user details', 'error');
      }
    }

    // Confirm Ban User
    async function confirmBanUser() {
      try {
        const banReason = document.getElementById('banReason');
        const banDuration = document.getElementById('banDuration');
        const banDetails = document.getElementById('banDetails');
        const banDeactivateAds = document.getElementById('banDeactivateAds');
        const banNotifyUser = document.getElementById('banNotifyUser');
        
        if (!banReason || !banDuration) {
          throw new Error('Ban form elements not found');
        }
        
        const reason = banReason.value;
        const duration = banDuration.value;
        const details = banDetails ? banDetails.value : '';
        const deactivateAds = banDeactivateAds ? banDeactivateAds.checked : false;
        const notifyUser = banNotifyUser ? banNotifyUser.checked : false;
        
        // Update user status (you'd need to add a banned_until column to profiles)
        // For now, we'll just log the action
        
        // Deactivate user's ads if requested
        if (deactivateAds) {
          const { error: adsError } = await sb
            .from('ads')
            .update({ status: 'banned' })
            .eq('seller_id', currentUserId);
          
          if (adsError) throw adsError;
        }
        
        // Log admin action
        const { error: actionError } = await sb
          .from('admin_actions')
          .insert({
            admin_id: currentUser.id,
            action_type: 'user_banned',
            target_user_id: currentUserId,
            details: {
              reason: reason,
              duration: duration,
              details: details,
              deactivate_ads: deactivateAds,
              notify_user: notifyUser
            }
          });
        
        if (actionError) throw actionError;
        
        // Notify user if requested
        if (notifyUser) {
          const { error: notifError } = await sb
            .from('notifications')
            .insert({
              user_id: currentUserId,
              type: 'admin_alert',
              title: 'Account Suspended',
              message: `Your account has been suspended. Reason: ${reason}. Duration: ${duration === 'permanent' ? 'Permanent' : duration + ' days'}.`,
              link: '/contact-support.html'
            });
          
          if (notifError) console.error('Failed to send notification:', notifError);
        }
        
        // Close modal and refresh
        closeModal('banUserModal');
        await loadUsers();
        showToast('User has been banned successfully');
        
      } catch (error) {
        console.error('Error banning user:', error);
        showToast('Failed to ban user', 'error');
      }
    }

    // Delete User
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }
      
      try {
        // Note: Deleting a user will cascade delete their ads, messages, etc.
        // due to foreign key constraints
        
        const { error } = await sb
          .from('profiles')
          .delete()
          .eq('id', userId);
        
        if (error) throw error;
        
        // Log admin action
        await sb.from('admin_actions').insert({
          admin_id: currentUser.id,
          action_type: 'user_banned', // Using banned as delete action
          target_user_id: userId,
          details: { action: 'user_deleted' }
        });
        
        // Close modal and refresh
        closeModal('editUserModal');
        await loadUsers();
        await loadDashboardStats();
        showToast('User deleted successfully');
        
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Failed to delete user. User may have associated data.', 'error');
      }
    }

    // Message User
    function messageUser(userId) {
      // Redirect to messages page with user pre-selected
      window.open(`admin-messages.html?user=${userId}`, '_blank');
    }

    // Export Users to CSV
    async function exportUsers() {
      try {
        // Get all filtered users
        let query = sb
          .from('profiles')
          .select('*');
        
        if (currentFilters.search) {
          // Note: Full-text search isn't implemented here
        }
        
        // Apply other filters...
        
        const { data: users, error } = await query;
        
        if (error) throw error;
        
        if (!users || users.length === 0) {
          showToast('No users to export', 'warning');
          return;
        }
        
        // Create CSV content
        const headers = ['ID', 'Name', 'Email', 'Phone', 'Location', 'District', 'Role', 'Verified', 'Total Ads', 'Joined Date', 'Last Active'];
        const rows = users.map(user => [
          user.id,
          user.full_name || '',
          user.email,
          user.phone || '',
          user.location || '',
          user.district || '',
          user.is_admin ? (user.admin_role || 'admin') : 'user',
          user.is_verified ? 'Yes' : 'No',
          user.total_ads || 0,
          formatDate(user.created_at),
          formatDate(user.last_active || user.created_at)
        ]);
        
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `users_export_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('CSV export started');
        
      } catch (error) {
        console.error('Error exporting users:', error);
        showToast('Failed to export users', 'error');
      }
    }

    // Refresh Data
    async function refreshData() {
      showToast('Refreshing data...', 'info');
      await Promise.all([
        loadDashboardStats(),
        loadUsers(),
        loadPendingCounts()
      ]);
      showToast('Data refreshed successfully');
    }

    // Logout
    async function logout() {
      try {
        // Log admin action if user is authenticated
        if (currentUser && currentUser.id) {
          await sb.from('admin_actions').insert({
            admin_id: currentUser.id,
            action_type: 'logout',
            details: { timestamp: new Date().toISOString() }
          });
        }
        
        // Sign out
        await sb.auth.signOut();
        window.location.href = 'login.html';
        
      } catch (error) {
        console.error('Error during logout:', error);
        window.location.href = 'login.html';
      }
    }

    // Modal Functions
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        currentUserId = null;
      }
    }

    function closeAllModals() {
      document.querySelectorAll('.modal-overlay.active').forEach(modal => {
        modal.classList.remove('active');
      });
      document.body.style.overflow = 'auto';
      currentUserId = null;
    }

    // Utility Functions
    function formatDate(dateString) {
      if (!dateString) return 'Never';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function formatTimeAgo(dateString) {
      if (!dateString) return 'Never';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);
      
      if (diffDay > 30) {
        return formatDate(dateString);
      } else if (diffDay > 0) {
        return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
      } else if (diffHour > 0) {
        return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
      } else if (diffMin > 0) {
        return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
      } else {
        return 'Just now';
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showToast(message, type = 'success') {
      const backgroundColor = type === 'error' ? '#dc2626' : 
                            type === 'warning' ? '#f59e0b' : 
                            type === 'info' ? '#0ea5e9' : '#16a34a';
      
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: backgroundColor,
        stopOnFocus: true
      }).showToast();
    }
  </script>
</body>
</html>